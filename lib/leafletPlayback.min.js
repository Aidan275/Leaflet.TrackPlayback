!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define("leafletPlayback",[],i):"object"==typeof exports?exports.leafletPlayback=i():t.leafletPlayback=i()}(this,function(){return function(t){function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}var e={};return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},i.p="",i(i.s=0)}([function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.playback=i.PlayBack=void 0;var n=e(1),s=e(2),r=e(3),a=e(5),o=e(7),c={},h={};c.Track=n.Track,c.TrackController=s.TrackController,c.Clock=r.Clock,c.Draw=a.Draw,h.track=n.track,h.trackController=s.trackController,h.clock=r.clock,h.draw=a.draw,c.Util=o.Util,i.PlayBack=c,i.playback=h,window.L.PlayBack=c,window.L.playback=h},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=i.Track=L.Class.extend({initialize:function(t,i){if(L.setOptions(this,i),this._trackPoints=[],this._timeTick={},t.timePosList&&t.timePosList.length){for(var e=0,n=t.timePosList.length;e<n;e++)t.timePosList[e].isOrigin=!0,this._trackPoints.push(t.timePosList[e]);this._update()}},addTrackPoint:function(t){t.isOrigin=!0,this._trackPoints.push(t),this._update()},getTimes:function(){for(var t=[],i=0,e=this._trackPoints.length;i<e;i++)t.push(this._trackPoints[i].time);return t},getStartTrackPoint:function(){return this._trackPoints[0]},getEndTrackPoint:function(){return this._trackPoints[this._trackPoints.length-1]},getTrackPointByTime:function(t){return this._timeTick[t]},getCalculateTrackPointByTime:function(t){var i=this.getTrackPointByTime(t),e=this.getStartTrackPoint(),n=this.getEndTrackPoint(),s=this.getTimes();if(!(t<e.time||t>n.time)){var r,a=0,o=s.length-1;if(a===o)return i;for(;o-a!=1;)r=parseInt((a+o)/2),t>s[r]?a=r:o=r;var c=s[a],h=s[o],l=t;this.getTrackPointByTime(c)||console.log("error"),e=L.point(this.getTrackPointByTime(c).lng,this.getTrackPointByTime(c).lat),n=L.point(this.getTrackPointByTime(h).lng,this.getTrackPointByTime(h).lat);var u=e.distanceTo(n);if(u<=0)return i=this.getTrackPointByTime(h);var _=u/(h-c),p=(n.y-e.y)/u,f=(n.x-e.x)/u,d=_*(l-c),m=e.x+d*f,k=e.y+d*p,T=n.x>=e.x?180*(.5*Math.PI-Math.asin(p))/Math.PI:180*(1.5*Math.PI+Math.asin(p))/Math.PI;return i?void 0===i.dir&&(i.dir=T):i={lng:m,lat:k,dir:T,isOrigin:!1,time:t},i}},getTrackPointsBeforeTime:function(t){for(var i=[],e=0,n=this._trackPoints.length;e<n;e++)this._trackPoints[e].time<t&&i.push(this._trackPoints[e]);var s=this.getCalculateTrackPointByTime(t);return s&&i.push(s),i},_update:function(){this._sortTrackPointsByTime(),this._updatetimeTick()},_sortTrackPointsByTime:function(){for(var t=this._trackPoints.length,i=0;i<t;i++)for(var e=0;e<t-1-i;e++)if(this._trackPoints[e].time>this._trackPoints[e+1].time){var n=this._trackPoints[e+1];this._trackPoints[e+1]=this._trackPoints[e],this._trackPoints[e]=n}},_updatetimeTick:function(){this._timeTick={};for(var t=0,i=this._trackPoints.length;t<i;t++)this._timeTick[this._trackPoints[t].time]=this._trackPoints[t]}});i.track=function(t,i){return new n(t,i)}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=i.TrackController=L.Class.extend({initialize:function(t,i,e){if(L.setOptions(this,e),this._tracks=[],this._minTime=null,this._maxTime=null,this._draw=i,t&&t.length)for(var n=0,s=t.length;n<s;n++)this._tracks.push(t[n]);this._update(),this._caculateCount()},getMinTime:function(){return this._minTime},getMaxTime:function(){return this._maxTime},addTrack:function(t){t&&(this._tracks.push(t),this._update())},drawTracksByTime:function(t){this._draw.clear();for(var i=0,e=this._tracks.length;i<e;i++){var n=this._tracks[i],s=n.getTrackPointsBeforeTime(t);s&&s.length&&this._draw.drawTrack(s)}},_update:function(){if(this._tracks.length){this._minTime=this._tracks[0].getStartTrackPoint().time,this._maxTime=this._tracks[0].getEndTrackPoint().time;for(var t=0,i=this._tracks.length;t<i;t++){var e=this._tracks[t].getStartTrackPoint().time,n=this._tracks[t].getEndTrackPoint().time;e<this._minTime&&(this._minTime=e),n>this._maxTime&&(this._maxTime=n)}}},_caculateCount:function(){for(var t=this._tracks.length,i=0,e=0,n=t;e<n;e++)i+=this._tracks[e]._trackPoints.length;console.log("共有: "+t+"艘船;"),console.log("共有: "+i+"个轨迹点;")}});i.trackController=function(t,i,e){return new n(t,i,e)}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.clock=i.Clock=void 0,e(4);var n=i.Clock=L.Class.extend({options:{speed:13,maxSpeed:65},initialize:function(t,i,e){L.setOptions(this,e),this._trackController=t,this._endTime=this._trackController.getMaxTime(),this._curTime=this._trackController.getMinTime(),this._speed=this.options.speed,this._maxSpeed=this.options.maxSpeed,this._callback=i||function(){},this._lastFpsUpdateTime=0},caculateFps:function(t){return 1e3/(t-this._lastFpsUpdateTime)},caculatefpsTime:function(t){var i=(t-this._lastFpsUpdateTime)/1e3;return 0===this._lastFpsUpdateTime&&(i=0),this._lastFpsUpdateTime=t,i},_tick:function(){var t=+new Date,i=this.caculatefpsTime(t),e=!1,n=i*Math.pow(2,this._speed-1);this._curTime+=n,this._curTime>=this._endTime&&(this._curTime=this._endTime,e=!0),this._trackController.drawTracksByTime(this._curTime),this._callback(this._curTime),e||(this._intervalID=window.requestAnimationFrame(this._tick.bind(this)))},start:function(){this._intervalID||(this._intervalID=window.requestAnimationFrame(this._tick.bind(this)))},stop:function(){this._intervalID&&(window.cancelAnimationFrame(this._intervalID),this._intervalID=null,this._lastFpsUpdateTime=0)},rePlaying:function(){this.stop(),this._curTime=this._trackController.getMinTime(),this.start()},slowSpeed:function(){this._speed<=1?this._speed:this._speed-=1,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed>=this._maxSpeed?this._speed:this._speed+=1,this._intervalID&&(this.stop(),this.start())},getSpeed:function(){return this._speed},getCurTime:function(){return this._curTime},getStartTime:function(){return this._trackController.getMinTime()},getEndTime:function(){return this._trackController.getMaxTime()},isPlaying:function(){return this._intervalID?1:0},setCursor:function(t){this._curTime=t,this._trackController.drawTracksByTime(this._curTime),this._callback(this._curTime)},setSpeed:function(t){this._speed=t,this._intervalID&&(this.stop(),this.start())}});i.clock=function(t,i,e){return new n(t,i,e)}},function(t,i,e){"use strict";window.requestAnimationFrame=function(){var t,i,e=navigator.userAgent,n=0,s=this;return window.webkitRequestAnimationFrame&&(i=function(t){void 0===t&&(t=+new Date),s.callback(t)},t=window.webkitRequestAnimationFrame,window.webkitRequestAnimationFrame=function(e,n){s.callback=e,t(i,n)}),window.mozRequestAnimationFrame&&(n=e.indexOf("rv:"),-1!==e.indexOf("Gecko")&&"2.0"===e.substr(n+3,3)&&(window.mozRequestAnimationFrame=void 0)),window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var e,n;window.setTimeout(function(){e=+new Date,t(e),n=+new Date,s.timeout=1e3/60-(n-e)},s.timeout)}}()},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.draw=i.Draw=void 0;var n=e(6),s=i.Draw=L.Class.extend({options:{trackPointOptions:{isDraw:!1,useCanvas:!0,stroke:!1,color:"#ef0300",fill:!0,fillColor:"#ef0300",radius:4},trackLineOptions:{isDraw:!1,stroke:!0,color:"#1C54E2",weight:2,fill:!1,fillColor:"#000"},shipOptions:{useImg:!1,imgUrl:"../../static/images/ship.png",width:8,height:18,color:"#00f",fillColor:"#9FD12D"},toolTipOptions:{offset:[0,0],direction:"top",permanent:!1}},initialize:function(t,i){L.setOptions(this,i),this._map=t,this._trackLayer=(new n.TrackLayer).addTo(t),this._canvas=this._trackLayer.getContainer(),this._ctx=this._canvas.getContext("2d"),this._bufferTracks=[],this._trackPointFeatureGroup=L.featureGroup([]).addTo(t),this._trackLayer.on("update",this._trackLayerUpdate,this),this._map.on("mousemove",this._onmousemoveEvt,this)},update:function(){this._trackLayerUpdate()},_trackLayerUpdate:function(){this._bufferTracks.length&&(this._clearLayer(),this._bufferTracks.forEach(function(t,i){this._drawTrack(t,!1)}.bind(this)))},_onmousemoveEvt:function(t){if(this.options.trackPointOptions.isDraw){var i=t.layerPoint;if(this._bufferTracks.length)for(var e=0,n=this._bufferTracks.length;e<n;e++)for(var s=0,r=this._bufferTracks[e].length;s<r;s++){var a=this._map.latLngToLayerPoint(L.latLng(this._bufferTracks[e][s].lat,this._bufferTracks[e][s].lng));if(i.distanceTo(a)<=this.options.trackPointOptions.radius)return void this._opentoolTip(this._bufferTracks[e][s])}this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._canvas.style.cursor="pointer"}},_opentoolTip:function(t){this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._canvas.style.cursor="default";var i=L.latLng(t.lat,t.lng),e=this._tooltip=L.tooltip(this.options.toolTipOptions);e.setLatLng(i),e.addTo(this._map),e.setContent(this.getTooltipText(t))},_drawTrack:function(t){this.options.trackLineOptions.isDraw&&this._drawTrackLine(t),this.options.shipOptions.useImg?this._drawShip2(t[t.length-1]):this._drawShip(t[t.length-1]),this.options.trackPointOptions.isDraw&&(this.options.trackPointOptions.useCanvas?this._drawTrackPoints(t):this._drawTrackPoints2(t))},drawTrack:function(t){this._bufferTracks.push(t),this._drawTrack(t)},_drawTrackLine:function(t){var i=this.options.trackLineOptions,e=this._map.latLngToLayerPoint(L.latLng(t[0].lat,t[0].lng));this._ctx.save(),this._ctx.beginPath(),this._ctx.moveTo(e.x,e.y);for(var n=1,s=t.length;n<s;n++){var r=this._map.latLngToLayerPoint(L.latLng(t[n].lat,t[n].lng));this._ctx.lineTo(r.x,r.y)}i.stroke&&(this._ctx.strokeStyle=i.color,this._ctx.lineWidth=i.weight,this._ctx.stroke()),i.fill&&(this._ctx.fillStyle=i.fillColor,this._ctx.fill()),this._ctx.restore()},_drawTrackPoints:function(t){var i=this.options.trackPointOptions;this._ctx.save();for(var e=0,n=t.length;e<n;e++)if(t[e].isOrigin){var s=L.latLng(t[e].lat,t[e].lng),r=i.radius,a=this._map.latLngToLayerPoint(s);this._ctx.beginPath(),this._ctx.arc(a.x,a.y,r,0,2*Math.PI,!1),i.stroke&&(this._ctx.strokeStyle=i.color,this._ctx.stroke()),i.fill&&(this._ctx.fillStyle=i.fillColor,this._ctx.fill())}this._ctx.restore()},_drawTrackPoints2:function(t){for(var i=0,e=t.length;i<e;i++)if(t[i].isOrigin){var n=L.latLng(t[i].lat,t[i].lng),s=L.circleMarker(n,this.options.trackPointOptions);s.bindTooltip(this.getTooltipText(t[i]),this.options.toolTipOptions),this._trackPointFeatureGroup.addLayer(s)}},_drawShip:function(t){var i=this._map.latLngToLayerPoint(L.latLng(t.lat,t.lng)),e=t.dir||0,n=this.options.shipOptions.width,s=this.options.shipOptions.height,r=s/3;this._ctx.save(),this._ctx.fillStyle=this.options.shipOptions.fillColor,this._ctx.strokeStyle=this.options.shipOptions.color,this._ctx.translate(i.x,i.y),this._ctx.rotate(Math.PI/180*e),this._ctx.beginPath(),this._ctx.moveTo(0,0-s/2),this._ctx.lineTo(0-n/2,0-s/2+r),this._ctx.lineTo(0-n/2,0+s/2),this._ctx.lineTo(0+n/2,0+s/2),this._ctx.lineTo(0+n/2,0-s/2+r),this._ctx.closePath(),this._ctx.fill(),this._ctx.stroke(),this._ctx.restore()},_drawShip2:function(t){var i=this._map.latLngToLayerPoint(L.latLng(t.lat,t.lng)),e=t.dir||0,n=this.options.shipOptions.width,s=this.options.shipOptions.height,r={x:n/2,y:s/2},a=new Image;a.onload=function(){this._ctx.save(),this._ctx.translate(i.x,i.y),this._ctx.rotate(Math.PI/180*e),this._ctx.drawImage(a,0-r.x,0-r.y,n,s),this._ctx.restore()}.bind(this),a.src=this.options.shipOptions.imgUrl},getTooltipText:function(t){var i=[];if(i.push("<table>"),t.info&&t.info.length)for(var e=0,n=t.info.length;e<n;e++)i.push("<tr>"),i.push("<td>"+t.info[e].key+"</td>"),i.push("<td>"+t.info[e].value+"</td>"),i.push("</tr>");return i.push("</table>"),i=i.join("")},removeLayer:function(){this._map.hasLayer(this._trackLayer)&&this._map.removeLayer(this._trackLayer),this._map.hasLayer(this._trackPointFeatureGroup)&&this._map.removeLayer(this._trackPointFeatureGroup)},_clearLayer:function(){var t=this._trackLayer.getBounds();if(t){var i=t.getSize();this._ctx.clearRect(t.min.x,t.min.y,i.x,i.y)}else this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);this._map.hasLayer(this._trackPointFeatureGroup)&&this._trackPointFeatureGroup.clearLayers()},clear:function(){this._clearLayer(),this._bufferTracks=[]}});i.draw=function(t,i){return new s(t,i)}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.TrackLayer=L.Renderer.extend({initialize:function(t){L.Renderer.prototype.initialize.call(this,t),this.options.padding=.1},onAdd:function(t){this._container=L.DomUtil.create("canvas","leaflet-zoom-animated"),this._container.setAttribute("id","canvas"),t.getPane(this.options.pane).appendChild(this._container),this._ctx=this._container.getContext("2d"),this._update()},onRemove:function(t){L.DomUtil.remove(this._container)},getContainer:function(){return this._container},getBounds:function(){return this._bounds},_update:function(){if(!this._map._animatingZoom||!this._bounds){L.Renderer.prototype._update.call(this);var t=this._bounds,i=this._container,e=t.getSize(),n=L.Browser.retina?2:1;L.DomUtil.setPosition(i,t.min),i.width=n*e.x,i.height=n*e.y,i.style.width=e.x+"px",i.style.height=e.y+"px",L.Browser.retina&&this._ctx.scale(2,2),this._ctx.translate(-t.min.x,-t.min.y),this.fire("update")}}})},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.Util={getTimeStrFromUnix:function(t){if(t=parseInt(1e3*t),isNaN(t))return"";var i=new Date(t);return i.getFullYear()+"-"+(i.getMonth()+1<10?"0"+(i.getMonth()+1):i.getMonth()+1)+"-"+(i.getDate()<10?"0"+i.getDate():i.getDate())+" "+(i.getHours()<10?"0"+i.getHours():i.getHours())+":"+(i.getMinutes()<10?"0"+i.getMinutes():i.getMinutes())+":"+(i.getSeconds()<10?"0"+i.getSeconds():i.getSeconds())},latlngTodfm:function(t,i,e,n){var s,r=[],a=parseFloat(t),o=Math.abs(a),c=parseInt(o),h=parseInt(60*o)-60*c,l=60*o*60-60*h-60*c*60;return(void 0===n||n<=0)&&(n=0),l=0===n?parseInt(l):l.toFixed(n),void 0===e&&(e=!0),e&&("lng"===i?(c<10&&(c="00"+c),c>=10&&c<100&&(c="0"+c)):c<10&&(c="0"+c)),"lat"===i&&(s=a<0?"S":"N"),"lng"===i&&(s=a<0?"W":"E"),r.push(c,h,l,s),r},latlngTodfmStr:function(t,i,e){var n=this.latlngTodfm(t,i,e);return n[3]+" "+n[0]+"°"+n[1]+"′"+n[2]+"″"}}}])});