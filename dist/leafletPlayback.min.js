!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define("leafletPlayback",[],i):"object"==typeof exports?exports.leafletPlayback=i():t.leafletPlayback=i()}(this,function(){return function(t){function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}var e={};return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},i.p="",i(i.s=0)}([function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.playback=i.PlayBack=void 0;var s=e(1),n=e(2),r=e(3),a=e(5),o=e(7),c={},h={};c.Track=s.Track,c.TrackController=n.TrackController,c.Clock=r.Clock,c.Draw=a.Draw,h.track=s.track,h.trackController=n.trackController,h.clock=r.clock,h.draw=a.draw,c.Util=o.Util,i.PlayBack=c,i.playback=h,window.L.PlayBack=c,window.L.playback=h},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=i.Track=L.Class.extend({initialize:function(t,i){if(L.setOptions(this,i),this._trackPoints=[],this._timeTick={},t.timePosList&&t.timePosList.length){for(var e=0,s=t.timePosList.length;e<s;e++)t.timePosList[e].isOrigin=!0,this._trackPoints.push(t.timePosList[e]);this._update()}},addTrackPoint:function(t){t.isOrigin=!0,this._trackPoints.push(t),this._update()},getTimes:function(){for(var t=[],i=0,e=this._trackPoints.length;i<e;i++)t.push(this._trackPoints[i].time);return t},getStartTrackPoint:function(){return this._trackPoints[0]},getEndTrackPoint:function(){return this._trackPoints[this._trackPoints.length-1]},getTrackPointByTime:function(t){return this._timeTick[t]},getCalculateTrackPointByTime:function(t){var i=this.getTrackPointByTime(t),e=this.getStartTrackPoint(),s=this.getEndTrackPoint(),n=this.getTimes();if(!(t<e.time||t>s.time)){var r,a=0,o=n.length-1;if(a===o)return i;for(;o-a!=1;)r=parseInt((a+o)/2),t>n[r]?a=r:o=r;var c=n[a],h=n[o],l=t;this.getTrackPointByTime(c)||console.log("error"),e=L.point(this.getTrackPointByTime(c).lng,this.getTrackPointByTime(c).lat),s=L.point(this.getTrackPointByTime(h).lng,this.getTrackPointByTime(h).lat);var u=e.distanceTo(s);if(u<=0)return i=this.getTrackPointByTime(h);var _=u/(h-c),p=(s.y-e.y)/u,f=(s.x-e.x)/u,d=_*(l-c),m=e.x+d*f,k=e.y+d*p,T=s.x>=e.x?180*(.5*Math.PI-Math.asin(p))/Math.PI:180*(1.5*Math.PI+Math.asin(p))/Math.PI;return i?void 0===i.dir&&(i.dir=T):i={lng:m,lat:k,dir:T,isOrigin:!1,time:t},i}},getTrackPointsBeforeTime:function(t){for(var i=[],e=0,s=this._trackPoints.length;e<s;e++)this._trackPoints[e].time<t&&i.push(this._trackPoints[e]);var n=this.getCalculateTrackPointByTime(t);return n&&i.push(n),i},_update:function(){this._sortTrackPointsByTime(),this._updatetimeTick()},_sortTrackPointsByTime:function(){for(var t=this._trackPoints.length,i=0;i<t;i++)for(var e=0;e<t-1-i;e++)if(this._trackPoints[e].time>this._trackPoints[e+1].time){var s=this._trackPoints[e+1];this._trackPoints[e+1]=this._trackPoints[e],this._trackPoints[e]=s}},_updatetimeTick:function(){this._timeTick={};for(var t=0,i=this._trackPoints.length;t<i;t++)this._timeTick[this._trackPoints[t].time]=this._trackPoints[t]}});i.track=function(t,i){return new s(t,i)}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=i.TrackController=L.Class.extend({initialize:function(t,i,e,s){if(L.setOptions(this,s),this._map=e,this._tracks=[],this._minTime=null,this._maxTime=null,this._draw=i,t&&t.length)for(var n=0,r=t.length;n<r;n++)this._tracks.push(t[n]);this._update(),this._caculateCount(),this.locateToFirstTrack()},getMinTime:function(){return this._minTime},getMaxTime:function(){return this._maxTime},locateToFirstTrack:function(){if(this._tracks.length){var t=this._tracks[0],i=t.getStartTrackPoint();if(i){var e=L.latLng(i.lat,i.lng);this._map.panTo(e)}}},addTrack:function(t){t&&(this._tracks.push(t),this._update())},drawTracksByTime:function(t){this._draw.clear();for(var i=0,e=this._tracks.length;i<e;i++){var s=this._tracks[i],n=s.getTrackPointsBeforeTime(t);n&&n.length&&this._draw.drawTrack(n)}},_update:function(){if(this._tracks.length){this._minTime=this._tracks[0].getStartTrackPoint().time,this._maxTime=this._tracks[0].getEndTrackPoint().time;for(var t=0,i=this._tracks.length;t<i;t++){var e=this._tracks[t].getStartTrackPoint().time,s=this._tracks[t].getEndTrackPoint().time;e<this._minTime&&(this._minTime=e),s>this._maxTime&&(this._maxTime=s)}}},_caculateCount:function(){for(var t=this._tracks.length,i=0,e=0,s=t;e<s;e++)i+=this._tracks[e]._trackPoints.length;console.log("共有: "+t+"艘船;"),console.log("共有: "+i+"个轨迹点;")}});i.trackController=function(t,i,e){return new s(t,i,e)}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.clock=i.Clock=void 0,e(4);var s=i.Clock=L.Class.extend({options:{speed:13,maxSpeed:65},initialize:function(t,i,e){L.setOptions(this,e),this._trackController=t,this._endTime=this._trackController.getMaxTime(),this._curTime=this._trackController.getMinTime(),this._speed=this.options.speed,this._maxSpeed=this.options.maxSpeed,this._callback=i||function(){},this._lastFpsUpdateTime=0},caculateFps:function(t){return 1e3/(t-this._lastFpsUpdateTime)},caculatefpsTime:function(t){var i=(t-this._lastFpsUpdateTime)/1e3;return 0===this._lastFpsUpdateTime&&(i=0),this._lastFpsUpdateTime=t,i},_tick:function(){var t=+new Date,i=this.caculatefpsTime(t),e=!1,s=i*Math.pow(2,this._speed-1);this._curTime+=s,this._curTime>=this._endTime&&(this._curTime=this._endTime,e=!0),this._trackController.drawTracksByTime(this._curTime),this._callback(this._curTime),e||(this._intervalID=window.requestAnimationFrame(this._tick.bind(this)))},start:function(){this._intervalID||(this._intervalID=window.requestAnimationFrame(this._tick.bind(this)))},stop:function(){this._intervalID&&(window.cancelAnimationFrame(this._intervalID),this._intervalID=null,this._lastFpsUpdateTime=0)},rePlaying:function(){this.stop(),this._curTime=this._trackController.getMinTime(),this.start()},slowSpeed:function(){this._speed<=1?this._speed:this._speed-=1,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed>=this._maxSpeed?this._speed:this._speed+=1,this._intervalID&&(this.stop(),this.start())},getSpeed:function(){return this._speed},getCurTime:function(){return this._curTime},getStartTime:function(){return this._trackController.getMinTime()},getEndTime:function(){return this._trackController.getMaxTime()},isPlaying:function(){return this._intervalID?1:0},setCursor:function(t){this._curTime=t,this._trackController.drawTracksByTime(this._curTime),this._callback(this._curTime)},setSpeed:function(t){this._speed=t,this._intervalID&&(this.stop(),this.start())}});i.clock=function(t,i,e){return new s(t,i,e)}},function(t,i,e){"use strict";window.requestAnimationFrame=function(){var t,i,e=navigator.userAgent,s=0,n=this;return window.webkitRequestAnimationFrame&&(i=function(t){void 0===t&&(t=+new Date),n.callback(t)},t=window.webkitRequestAnimationFrame,window.webkitRequestAnimationFrame=function(e,s){n.callback=e,t(i,s)}),window.mozRequestAnimationFrame&&(s=e.indexOf("rv:"),-1!==e.indexOf("Gecko")&&"2.0"===e.substr(s+3,3)&&(window.mozRequestAnimationFrame=void 0)),window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){var e,s;window.setTimeout(function(){e=+new Date,t(e),s=+new Date,n.timeout=1e3/60-(s-e)},n.timeout)}}()},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.draw=i.Draw=void 0;var s=e(6),n=i.Draw=L.Class.extend({trackPointOptions:{isDraw:!1,useCanvas:!0,stroke:!1,color:"#ef0300",fill:!0,fillColor:"#ef0300",opacity:.3,radius:4},trackLineOptions:{isDraw:!1,stroke:!0,color:"#1C54E2",weight:2,fill:!1,fillColor:"#000",opacity:.3},shipOptions:{useImg:!1,imgUrl:"../../static/images/ship.png",width:8,height:18,color:"#00f",fillColor:"#9FD12D"},toolTipOptions:{offset:[0,0],direction:"top",permanent:!1},initialize:function(t,i){this.trackPointOptions=L.extend(this.trackPointOptions,i.trackPointOptions),this.trackLineOptions=L.extend(this.trackLineOptions,i.trackLineOptions),this.shipOptions=L.extend(this.shipOptions,i.shipOptions),this.toolTipOptions=L.extend(this.toolTipOptions,i.toolTipOptions),this._map=t,this._trackLayer=(new s.TrackLayer).addTo(t),this._canvas=this._trackLayer.getContainer(),this._ctx=this._canvas.getContext("2d"),this._bufferTracks=[],this._trackPointFeatureGroup=L.featureGroup([]).addTo(t),this._trackLayer.on("update",this._trackLayerUpdate,this),this._map.on("mousemove",this._onmousemoveEvt,this)},update:function(){this._trackLayerUpdate()},_trackLayerUpdate:function(){this._bufferTracks.length&&(this._clearLayer(),this._bufferTracks.forEach(function(t,i){this._drawTrack(t,!1)}.bind(this)))},_onmousemoveEvt:function(t){if(this.trackPointOptions.isDraw){var i=t.layerPoint;if(this._bufferTracks.length)for(var e=0,s=this._bufferTracks.length;e<s;e++)for(var n=0,r=this._bufferTracks[e].length;n<r;n++){var a=this._map.latLngToLayerPoint(L.latLng(this._bufferTracks[e][n].lat,this._bufferTracks[e][n].lng));if(i.distanceTo(a)<=this.trackPointOptions.radius)return void this._opentoolTip(this._bufferTracks[e][n])}this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._canvas.style.cursor="pointer"}},_opentoolTip:function(t){this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._canvas.style.cursor="default";var i=L.latLng(t.lat,t.lng),e=this._tooltip=L.tooltip(this.toolTipOptions);e.setLatLng(i),e.addTo(this._map),e.setContent(this.getTooltipText(t))},_drawTrack:function(t){this.trackLineOptions.isDraw&&this._drawTrackLine(t),this.shipOptions.useImg?this._drawShip2(t[t.length-1]):this._drawShip(t[t.length-1]),this.trackPointOptions.isDraw&&(this.trackPointOptions.useCanvas?this._drawTrackPoints(t):this._drawTrackPoints2(t))},drawTrack:function(t){this._bufferTracks.push(t),this._drawTrack(t)},_drawTrackLine:function(t){var i=this.trackLineOptions,e=this._map.latLngToLayerPoint(L.latLng(t[0].lat,t[0].lng));this._ctx.save(),this._ctx.beginPath(),this._ctx.moveTo(e.x,e.y);for(var s=1,n=t.length;s<n;s++){var r=this._map.latLngToLayerPoint(L.latLng(t[s].lat,t[s].lng));this._ctx.lineTo(r.x,r.y)}this._ctx.globalAlpha=i.opacity,i.stroke&&(this._ctx.strokeStyle=i.color,this._ctx.lineWidth=i.weight,this._ctx.stroke()),i.fill&&(this._ctx.fillStyle=i.fillColor,this._ctx.fill()),this._ctx.restore()},_drawTrackPoints:function(t){var i=this.trackPointOptions;this._ctx.save();for(var e=0,s=t.length;e<s;e++)if(t[e].isOrigin){var n=L.latLng(t[e].lat,t[e].lng),r=i.radius,a=this._map.latLngToLayerPoint(n);this._ctx.beginPath(),this._ctx.arc(a.x,a.y,r,0,2*Math.PI,!1),this._ctx.globalAlpha=i.opacity,i.stroke&&(this._ctx.strokeStyle=i.color,this._ctx.stroke()),i.fill&&(this._ctx.fillStyle=i.fillColor,this._ctx.fill())}this._ctx.restore()},_drawTrackPoints2:function(t){for(var i=0,e=t.length;i<e;i++)if(t[i].isOrigin){var s=L.latLng(t[i].lat,t[i].lng),n=L.circleMarker(s,this.trackPointOptions);n.bindTooltip(this.getTooltipText(t[i]),this.toolTipOptions),this._trackPointFeatureGroup.addLayer(n)}},_drawShip:function(t){var i=this._map.latLngToLayerPoint(L.latLng(t.lat,t.lng)),e=t.dir||0,s=this.shipOptions.width,n=this.shipOptions.height,r=n/3;this._ctx.save(),this._ctx.fillStyle=this.shipOptions.fillColor,this._ctx.strokeStyle=this.shipOptions.color,this._ctx.translate(i.x,i.y),this._ctx.rotate(Math.PI/180*e),this._ctx.beginPath(),this._ctx.moveTo(0,0-n/2),this._ctx.lineTo(0-s/2,0-n/2+r),this._ctx.lineTo(0-s/2,0+n/2),this._ctx.lineTo(0+s/2,0+n/2),this._ctx.lineTo(0+s/2,0-n/2+r),this._ctx.closePath(),this._ctx.fill(),this._ctx.stroke(),this._ctx.restore()},_drawShip2:function(t){var i=this._map.latLngToLayerPoint(L.latLng(t.lat,t.lng)),e=t.dir||0,s=this.shipOptions.width,n=this.shipOptions.height,r={x:s/2,y:n/2},a=new Image;a.onload=function(){this._ctx.save(),this._ctx.translate(i.x,i.y),this._ctx.rotate(Math.PI/180*e),this._ctx.drawImage(a,0-r.x,0-r.y,s,n),this._ctx.restore()}.bind(this),a.src=this.shipOptions.imgUrl},getTooltipText:function(t){var i=[];if(i.push("<table>"),t.info&&t.info.length)for(var e=0,s=t.info.length;e<s;e++)i.push("<tr>"),i.push("<td>"+t.info[e].key+"</td>"),i.push("<td>"+t.info[e].value+"</td>"),i.push("</tr>");return i.push("</table>"),i=i.join("")},removeLayer:function(){this._bufferTracks=[],this._trackLayer.off("update",this._trackLayerUpdate,this),this._map.off("mousemove",this._onmousemoveEvt,this),this._map.hasLayer(this._trackLayer)&&this._map.removeLayer(this._trackLayer),this._map.hasLayer(this._trackPointFeatureGroup)&&this._map.removeLayer(this._trackPointFeatureGroup)},_clearLayer:function(){var t=this._trackLayer.getBounds();if(t){var i=t.getSize();this._ctx.clearRect(t.min.x,t.min.y,i.x,i.y)}else this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);this._map.hasLayer(this._trackPointFeatureGroup)&&this._trackPointFeatureGroup.clearLayers()},clear:function(){this._clearLayer(),this._bufferTracks=[]}});i.draw=function(t,i){return new n(t,i)}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.TrackLayer=L.Renderer.extend({initialize:function(t){L.Renderer.prototype.initialize.call(this,t),this.options.padding=.1},onAdd:function(t){this._container=L.DomUtil.create("canvas","leaflet-zoom-animated"),t.getPane(this.options.pane).appendChild(this._container),this._ctx=this._container.getContext("2d"),this._update()},onRemove:function(t){L.DomUtil.remove(this._container)},getContainer:function(){return this._container},getBounds:function(){return this._bounds},_update:function(){if(!this._map._animatingZoom||!this._bounds){L.Renderer.prototype._update.call(this);var t=this._bounds,i=this._container,e=t.getSize(),s=L.Browser.retina?2:1;L.DomUtil.setPosition(i,t.min),i.width=s*e.x,i.height=s*e.y,i.style.width=e.x+"px",i.style.height=e.y+"px",L.Browser.retina&&this._ctx.scale(2,2),this._ctx.translate(-t.min.x,-t.min.y),this.fire("update")}}})},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.Util={getTimeStrFromUnix:function(t,i){if(i=i||"s",t=parseInt(1e3*t),isNaN(t))return"";var e=new Date(t),s=e.getFullYear(),n=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,r=e.getDate()<10?"0"+e.getDate():e.getDate(),a=e.getHours()<10?"0"+e.getHours():e.getHours(),o=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),c=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();if("d"===i)var h=s+"-"+n+"-"+r;else if("h"===i)var h=s+"-"+n+"-"+r+" "+a;else if("m"===i)var h=s+"-"+n+"-"+r+" "+a+":"+o;else var h=s+"-"+n+"-"+r+" "+a+":"+o+":"+c;return h},latlngTodfm:function(t,i,e,s){var n,r=[],a=parseFloat(t),o=Math.abs(a),c=parseInt(o),h=parseInt(60*o)-60*c,l=60*o*60-60*h-60*c*60;return(void 0===s||s<=0)&&(s=0),l=0===s?parseInt(l):l.toFixed(s),void 0===e&&(e=!0),e&&("lng"===i?(c<10&&(c="00"+c),c>=10&&c<100&&(c="0"+c)):c<10&&(c="0"+c)),"lat"===i&&(n=a<0?"S":"N"),"lng"===i&&(n=a<0?"W":"E"),r.push(c,h,l,n),r},latlngTodfmStr:function(t,i,e){var s=this.latlngTodfm(t,i,e);return s[3]+" "+s[0]+"°"+s[1]+"′"+s[2]+"″"}}}])});