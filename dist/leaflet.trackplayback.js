!function(t,i){if("object"==typeof exports&&"object"==typeof module)module.exports=i(require("leaflet"));else if("function"==typeof define&&define.amd)define(["leaflet"],i);else{var e="object"==typeof exports?i(require("leaflet")):i(t.L);for(var s in e)("object"==typeof exports?exports:t)[s]=e[s]}}(window,(function(t){return function(t){var i={};function e(s){if(i[s])return i[s].exports;var r=i[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,e),r.l=!0,r.exports}return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var r in t)e.d(s,r,function(i){return t[i]}.bind(null,r));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=1)}([function(i,e){i.exports=t},function(t,i,e){"use strict";e.r(i);var s=e(0),r=e.n(s);function n(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)}const a=r.a.Layer.extend({initialize:function(t=[],i){r.a.setOptions(this,i),t.forEach(t=>{t.isOrigin=!0}),this._trackPoints=t,this._timeTick={},this._update()},addTrackPoint:function(t){if(n(t))for(let i=0,e=t.length;i<e;i++)this.addTrackPoint(t[i]);this._addTrackPoint(t)},getTimes:function(){let t=[];for(let i=0,e=this._trackPoints.length;i<e;i++)t.push(this._trackPoints[i].time);return t},getStartTrackPoint:function(){return this._trackPoints[0]},getEndTrackPoint:function(){return this._trackPoints[this._trackPoints.length-1]},getTrackPointByTime:function(t){return this._trackPoints[this._timeTick[t]]},getAllTrackPoints:function(){return this._trackPoints},_formatDistance:function(t){return t<1e3?`${t.toFixed(2)} m`:`${(t/1e3).toFixed(2)} km`},_getCalculateTrackPointByTime:function(t){let i=this.getTrackPointByTime(t),e=this.getStartTrackPoint(),s=this.getEndTrackPoint(),n=this.getTimes();if(t<e.time||t>s.time)return;let a,o=0,h=n.length-1;if(o===h)return i;for(;h-o!=1;)a=parseInt((o+h)/2),t>n[a]?o=a:h=a;let c=n[o],l=n[h],_=t,u=this.getTrackPointByTime(c),p=this.getTrackPointByTime(l);e=r.a.point(u.lng,u.lat),s=r.a.point(p.lng,p.lat);let f=e.distanceTo(s);if(f<=0)return i=p,i;let d=f/(l-c),k=(p.radius-u.radius)/(l-c),m=(s.y-e.y)/f,T=(s.x-e.x)/f,g=d*(_-c),y=k*(_-c),P=e.x+g*T,x=e.y+g*m,w=u.radius+y,L=s.x>=e.x?180*(.5*Math.PI-Math.asin(m))/Math.PI:180*(1.5*Math.PI+Math.asin(m))/Math.PI;return i?(void 0===i.dir&&(i.dir=L),void 0===i.radius&&(i.radius=w)):i={lng:P,lat:x,dir:L,isOrigin:!1,time:t,radius:w,info:[{key:"Accuracy:",value:this._formatDistance(w)}]},i},getTrackPointsBeforeTime:function(t){let i=[];for(let e=0,s=this._trackPoints.length;e<s;e++)this._trackPoints[e].time<t&&i.push(this._trackPoints[e]);let e=this._getCalculateTrackPointByTime(t);return e&&i.push(e),i},_addTrackPoint:function(t){t.isOrigin=!0,this._trackPoints.push(t),this._update()},_update:function(){this._sortTrackPointsByTime(),this._updatetimeTick()},_sortTrackPointsByTime:function(){let t=this._trackPoints.length;for(let i=0;i<t;i++)for(let e=0;e<t-1-i;e++)if(this._trackPoints[e].time>this._trackPoints[e+1].time){let t=this._trackPoints[e+1];this._trackPoints[e+1]=this._trackPoints[e],this._trackPoints[e]=t}},_updatetimeTick:function(){this._timeTick={};for(let t=0,i=this._trackPoints.length;t<i;t++)this._timeTick[this._trackPoints[t].time]=t}}),o=r.a.Layer.extend({initialize:function(t=[],i,e){r.a.setOptions(this,e),this._tracks=[],this._tps=[],this.addTrack(t),this._draw=i,this._updateTime()},getMinTime:function(){return this._minTime},getMaxTime:function(){return this._maxTime},getTrackPoints:function(){return this._tps},addTrack:function(t){if(n(t))for(let i=0,e=t.length;i<e;i++)this.addTrack(t[i]);else{if(!(t instanceof a))throw new Error("tracks must be an instance of `Track` or an array of `Track` instance!");this._tracks.push(t),this._updateTime()}},drawTracksByTime:function(t){this._draw.clear(),this._drawnTracks=[];for(let i=0,e=this._tracks.length;i<e;i++){let e=this._tracks[i];this._tps=e.getTrackPointsBeforeTime(t),this._tps&&this._tps.length&&this._draw.drawTrack(this._tps)}},getCurrentPoints:function(){return{prev:this._tps[this._tps.length-2],curr:this._tps[this._tps.length-1],next:this._tracks[0].getAllTrackPoints()[this._tps.length]}},_updateTime:function(){this._minTime=this._tracks[0].getStartTrackPoint().time,this._maxTime=this._tracks[0].getEndTrackPoint().time;for(let t=0,i=this._tracks.length;t<i;t++){let i=this._tracks[t].getStartTrackPoint().time,e=this._tracks[t].getEndTrackPoint().time;i<this._minTime&&(this._minTime=i),e>this._maxTime&&(this._maxTime=e)}}}),h=r.a.Layer.extend({options:{speed:12,maxSpeed:65},initialize:function(t,i){r.a.setOptions(this,i),this._trackController=t,this._endTime=this._trackController.getMaxTime(),this._curTime=this._trackController.getMinTime(),this._speed=this.options.speed,this._maxSpeed=this.options.maxSpeed,this._intervalID=null,this._lastFpsUpdateTime=0},start:function(){this._intervalID||(this._intervalID=r.a.Util.requestAnimFrame(this._tick,this))},stop:function(){this._intervalID&&(r.a.Util.cancelAnimFrame(this._intervalID),this._intervalID=null,this._lastFpsUpdateTime=0)},rePlaying:function(){this.stop(),this._curTime=this._trackController.getMinTime(),this.start()},slowSpeed:function(){this._speed=this._speed<=1?this._speed:this._speed-1,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed=this._speed>=this._maxSpeed?this._speed:this._speed+1,this._intervalID&&(this.stop(),this.start())},getSpeed:function(){return this._speed},getCurTime:function(){return this._curTime},getStartTime:function(){return this._trackController.getMinTime()},getEndTime:function(){return this._trackController.getMaxTime()},getTrackPoints:function(){return this._trackController.getTrackPoints()},isPlaying:function(){return!!this._intervalID},setCursor:function(t){this._curTime=t,this._trackController.drawTracksByTime(this._curTime);const{prev:i,curr:e,next:s}=this._trackController.getCurrentPoints();this.fire("tick",{prev:i,curr:e,next:s,time:this._curTime})},setSpeed:function(t){this._speed=t,this._intervalID&&(this.stop(),this.start())},_caculatefpsTime:function(t){let i;return i=0===this._lastFpsUpdateTime?0:t-this._lastFpsUpdateTime,this._lastFpsUpdateTime=t,i/=1e3,i},_tick:function(){let t=+new Date,i=!1,e=this._caculatefpsTime(t)*Math.pow(2,this._speed-1);this._curTime+=e,this._curTime>=this._endTime&&(this._curTime=this._endTime,i=!0),this._trackController.drawTracksByTime(this._curTime);const{prev:s,curr:n,next:a}=this._trackController.getCurrentPoints();this.fire("tick",{prev:s,curr:n,next:a,time:this._curTime}),i||(this._intervalID=r.a.Util.requestAnimFrame(this._tick,this))}}),c=r.a.Renderer.extend({initialize:function(t){r.a.Renderer.prototype.initialize.call(this,t),this.options.padding=.1},onAdd:function(t){this._container=r.a.DomUtil.create("canvas","leaflet-zoom-animated"),t.getPane(this.options.pane).appendChild(this._container),this._ctx=this._container.getContext("2d"),this._update()},onRemove:function(t){r.a.DomUtil.remove(this._container)},getContainer:function(){return this._container},getBounds:function(){return this._bounds},_update:function(){if(!this._map._animatingZoom||!this._bounds){r.a.Renderer.prototype._update.call(this);var t=this._bounds,i=this._container,e=t.getSize(),s=r.a.Browser.retina?2:1;r.a.DomUtil.setPosition(i,t.min),i.width=s*e.x,i.height=s*e.y,i.style.width=e.x+"px",i.style.height=e.y+"px",r.a.Browser.retina&&this._ctx.scale(2,2),this._ctx.translate(-t.min.x,-t.min.y),this.fire("update")}}}),l=r.a.Layer.extend({trackPointOptions:{isDraw:!0,useCanvas:!0,stroke:!0,color:"#000",fill:!0,fillColor:"#3388ff",opacity:1,radius:5},trackLineOptions:{isDraw:!0,stroke:!0,color:"#3388ff",weight:2,fill:!1,fillColor:"#000",opacity:1},targetOptions:{useImg:!1,imgUrl:"../../static/images/ship.png",showText:!1,width:8,height:18,color:"#00f",fillColor:"#9FD12D"},toolTipOptions:{offset:[0,0],direction:"top",permanent:!0},circleOptions:{fillColor:"#00f"},initialize:function(t,i){if(r.a.extend(this.trackPointOptions,i.trackPointOptions),r.a.extend(this.trackLineOptions,i.trackLineOptions),r.a.extend(this.targetOptions,i.targetOptions),r.a.extend(this.toolTipOptions,i.toolTipOptions),this._showTrackPoint=this.trackPointOptions.isDraw,this._showTrackLine=this.trackLineOptions.isDraw,this._map=t,this._map.on("mousemove",this._onmousemoveEvt,this),this._map.on("click",this._onmouseclickEvt,this),this._trackLayer=(new c).addTo(t),this._trackLayer.on("update",this._trackLayerUpdate,this),this._canvas=this._trackLayer.getContainer(),this._ctx=this._canvas.getContext("2d"),this._bufferTracks=[],this.trackPointOptions.useCanvas||(this._trackPointFeatureGroup=r.a.featureGroup([]).addTo(t)),this.targetOptions.useImg){const t=new Image;t.onload=()=>{this._targetImg=t},t.onerror=()=>{throw new Error("img load error!")},t.src=this.targetOptions.imgUrl}},update:function(){this._trackLayerUpdate()},drawTrack:function(t){this._bufferTracks.push(t),this._drawTrack(t)},showTrackPoint:function(){this._showTrackPoint=!0,this.update()},hideTrackPoint:function(){this._showTrackPoint=!1,this.update()},showTrackLine:function(){this._showTrackLine=!0,this.update()},hideTrackLine:function(){this._showTrackLine=!1,this.update()},remove:function(){this._bufferTracks=[],this._trackLayer.off("update",this._trackLayerUpdate,this),this._map.off("mousemove",this._onmousemoveEvt,this),this._map.off("click",this._onmouseclickEvt,this),this._map.hasLayer(this._trackLayer)&&this._map.removeLayer(this._trackLayer),this._map.hasLayer(this._trackPointFeatureGroup)&&this._map.removeLayer(this._trackPointFeatureGroup),this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._map.hasLayer(this._circle)&&this._map.removeLayer(this._circle),this._map.hasLayer(this._shipRadius)&&this._map.removeLayer(this._shipRadius)},clear:function(){this._clearLayer(),this._bufferTracks=[]},_trackLayerUpdate:function(){this._bufferTracks.length&&(this._clearLayer(),this._bufferTracks.forEach(function(t,i){this._drawTrack(t)}.bind(this)))},_onmousemoveEvt:function(t){if(this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._map.hasLayer(this._circle)&&this._map.removeLayer(this._circle),!this._showTrackPoint)return void(this._canvas.style.cursor="grab");let i=t.layerPoint;if(this._bufferTracks.length)for(let t=0,e=this._bufferTracks.length;t<e;t++)for(let e=0,s=this._bufferTracks[t].length;e<s;e++){let s=this._getLayerPoint(this._bufferTracks[t][e]);if(i.distanceTo(s)<=this.trackPointOptions.radius)return this._canvas.style.cursor="pointer",void this._opentoolTip(this._bufferTracks[t][e])}this._canvas.style.cursor="grab"},_onmouseclickEvt:function(t){this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._map.hasLayer(this._circle)&&this._map.removeLayer(this._circle);let i=t.layerPoint;if(this._bufferTracks.length)for(let t=0,e=this._bufferTracks.length;t<e;t++)for(let e=0,s=this._bufferTracks[t].length;e<s;e++){let s=this._getLayerPoint(this._bufferTracks[t][e]);if(i.distanceTo(s)<=this.trackPointOptions.radius)return this.fire("click",this._bufferTracks[t][e]),void this._opentoolTip(this._bufferTracks[t][e])}},_opentoolTip:function(t){let i=r.a.latLng(t.lat,t.lng);if(t.info){let e=this._tooltip=r.a.tooltip(this.toolTipOptions);e.setLatLng(i),e.addTo(this._map),e.setContent(this._getTooltipText(t))}if(t.radius){let e=this._circle=r.a.circle(this.circleOptions);e.setLatLng(i),e.setRadius(t.radius),e.addTo(this._map)}},_drawTrack:function(t){this._showTrackLine&&this._drawTrackLine(t),this._showTrackPoint&&(this.trackPointOptions.useCanvas?this._drawTrackPointsCanvas(t):this._drawTrackPointsSvg(t));let i=t[t.length-1];this.targetOptions.useImg&&this._targetImg?(this._drawShipImage(i),this._drawShipRadius(i)):(this._drawShipRadius(i),this._drawShipCanvas(i))},_drawTrackLine:function(t){let i=this.trackLineOptions,e=this._getLayerPoint(t[0]);this._ctx.save(),this._ctx.beginPath(),this._ctx.moveTo(e.x,e.y);for(let i=1,e=t.length;i<e;i++){let e=this._getLayerPoint(t[i]);this._ctx.lineTo(e.x,e.y)}this._ctx.globalAlpha=i.opacity,i.stroke&&(this._ctx.strokeStyle=i.color,this._ctx.lineWidth=i.weight,this._ctx.stroke()),i.fill&&(this._ctx.fillStyle=i.fillColor,this._ctx.fill()),this._ctx.restore()},_drawTrackPointsCanvas:function(t){let i=this.trackPointOptions;this._ctx.save();for(let e=0,s=t.length;e<s;e++)if(t[e].isOrigin){let s=r.a.latLng(t[e].lat,t[e].lng),n=i.radius,a=this._map.latLngToLayerPoint(s);this._ctx.beginPath(),this._ctx.arc(a.x,a.y,n,0,2*Math.PI,!1),this._ctx.globalAlpha=i.opacity,i.stroke&&(this._ctx.strokeStyle=i.color,this._ctx.stroke()),i.fill&&(this._ctx.fillStyle=i.fillColor,this._ctx.fill())}this._ctx.restore()},_drawTrackPointsSvg:function(t){for(let i=0,e=t.length;i<e;i++)if(t[i].isOrigin){let e=r.a.latLng(t[i].lat,t[i].lng),s=r.a.circleMarker(e,this.trackPointOptions);s.bindTooltip(this._getTooltipText(t[i]),this.toolTipOptions),this._trackPointFeatureGroup.addLayer(s)}},_drawtxt:function(t,i){let e=this._getLayerPoint(i);this._ctx.save(),this._ctx.font="12px Verdana",this._ctx.fillStyle="#000",this._ctx.textAlign="center",this._ctx.textBaseline="bottom",this._ctx.fillText(t,e.x,e.y-12,200),this._ctx.restore()},_drawShipCanvas:function(t){let i=this._getLayerPoint(t),e=t.dir||0,s=this.targetOptions.width,r=this.targetOptions.height,n=r/3;this._ctx.save(),this._ctx.fillStyle=this.targetOptions.fillColor,this._ctx.strokeStyle=this.targetOptions.color,this._ctx.translate(i.x,i.y),this._ctx.rotate(Math.PI/180*e),this._ctx.beginPath(),this._ctx.moveTo(0,0-r/2),this._ctx.lineTo(0-s/2,0-r/2+n),this._ctx.lineTo(0-s/2,0+r/2),this._ctx.lineTo(0+s/2,0+r/2),this._ctx.lineTo(0+s/2,0-r/2+n),this._ctx.closePath(),this._ctx.fill(),this._ctx.stroke(),this._ctx.restore()},_drawShipRadius:function(t){this._map.hasLayer(this._shipRadius)&&this._map.removeLayer(this._shipRadius);let i=r.a.latLng(t.lat,t.lng),e=this._shipRadius=r.a.circle(this.circleOptions);e.setLatLng(i),e.setRadius(t.radius),e.addTo(this._map)},_drawShipImage:function(t){let i=this._getLayerPoint(t),e=t.dir||0,s=this.targetOptions.width,r=this.targetOptions.height,n=s/2,a=r/2;this._ctx.save(),this._ctx.translate(i.x,i.y),this._ctx.rotate(Math.PI/180*e),this._ctx.drawImage(this._targetImg,0-n,0-a,s,r),this._ctx.restore()},_getTooltipText:function(t){let i=[];if(i.push("<table>"),t.ts&&(i.push("<tr>"),i.push(t.ts),i.push("</tr>")),t.info&&t.info.length)for(let e=0,s=t.info.length;e<s;e++)i.push("<tr>"),i.push("<td>"+t.info[e].key+"</td>"),i.push("<td>"+t.info[e].value+"</td>"),i.push("</tr>");return i.push("</table>"),i=i.join(""),i},_clearLayer:function(){let t=this._trackLayer.getBounds();if(t){let i=t.getSize();this._ctx.clearRect(t.min.x,t.min.y,i.x,i.y)}else this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);this._map.hasLayer(this._trackPointFeatureGroup)&&this._trackPointFeatureGroup.clearLayers()},_getLayerPoint:function(t){return this._map.latLngToLayerPoint(r.a.latLng(t.lat,t.lng))}}),_=r.a.Layer.extend({initialize:function(t,i,e={}){let s={trackPointOptions:e.trackPointOptions,trackLineOptions:e.trackLineOptions,targetOptions:e.targetOptions,toolTipOptions:e.toolTipOptions};this.tracks=this._initTracks(t),this.draw=new l(i,s),this.draw.on("click",t=>this.fire("click",t),this),this.trackController=new o(this.tracks,this.draw),this.clock=new h(this.trackController,e.clockOptions),this.clock.on("tick",this._tick,this)},start:function(){return this.clock.start(),this},stop:function(){return this.clock.stop(),this},rePlaying:function(){return this.clock.rePlaying(),this},slowSpeed:function(){return this.clock.slowSpeed(),this},quickSpeed:function(){return this.clock.quickSpeed(),this},getSpeed:function(){return this.clock.getSpeed()},getCurTime:function(){return this.clock.getCurTime()},getStartTime:function(){return this.clock.getStartTime()},getEndTime:function(){return this.clock.getEndTime()},getTrackPoints:function(){return this.clock.getTrackPoints()},isPlaying:function(){return this.clock.isPlaying()},setCursor:function(t){return this.clock.setCursor(t),this},setSpeed:function(t){return this.clock.setSpeed(t),this},showTrackPoint:function(){return this.draw.showTrackPoint(),this},hideTrackPoint:function(){return this.draw.hideTrackPoint(),this},showTrackLine:function(){return this.draw.showTrackLine(),this},hideTrackLine:function(){return this.draw.hideTrackLine(),this},dispose:function(){this.clock.off("tick",this._tick),this.clock.stop(),this.draw.remove(),this.tracks=null,this.draw=null,this.trackController=null,this.clock=null},_tick:function(t){this.fire("tick",t)},_initTracks:function(t){let i=[];if(n(t))if(n(t[0]))for(let e=0,s=t.length;e<s;e++)i.push(new a(t[e]));else i.push(new a(t));return i}});r.a.TrackPlayBack=_,r.a.trackplayback=function(t,i,e){return new _(t,i,e)}}])}));
//# sourceMappingURL=leaflet.trackplayback.js.map